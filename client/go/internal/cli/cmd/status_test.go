// Copyright Vespa.ai. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.
// status command tests
// Author: bratseth

package cmd

import (
	"io"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/vespa-engine/vespa/client/go/internal/mock"
	"github.com/vespa-engine/vespa/client/go/internal/vespa"
)

func TestStatusDeployCommand(t *testing.T) {
	assertDeployStatus("http://127.0.0.1:19071", []string{}, t)
}

func TestStatusDeployCommandWithURLTarget(t *testing.T) {
	assertDeployStatus("http://mydeploytarget:19071", []string{"-t", "http://mydeploytarget:19071"}, t)
}

func TestStatusDeployCommandWithLocalTarget(t *testing.T) {
	assertDeployStatus("http://127.0.0.1:19071", []string{"-t", "local"}, t)
}

func TestStatusCommand(t *testing.T) {
	assertStatus("http://127.0.0.1:8080", []string{}, t)
}

func TestStatusCommandMultiCluster(t *testing.T) {
	client := &mock.HTTPClient{}
	cli, stdout, stderr := newTestCLI(t)
	cli.httpClient = client
	cli.retryInterval = 0

	mockServiceStatus(client)
	assert.NotNil(t, cli.Run("status"))
	assert.Equal(t, "Error: no services exist\nHint: Deployment may not be ready yet\nHint: Try 'vespa status deployment'\n", stderr.String())
	stderr.Reset()

	mockServiceStatus(client, "foo", "bar")
	client.NextStatus(200)
	client.NextStatus(400) // One cluster is unavilable
	assert.NotNil(t, cli.Run("status"))
	assert.Equal(t, `Container bar at http://127.0.0.1:8080 is ready
Container foo at http://127.0.0.1:8080 is not ready: unhealthy container foo: status 400 at http://127.0.0.1:8080/status.html: aborting wait: got status 400
`, stdout.String())
	assert.Equal(t,
		"Error: services not ready: foo\n",
		stderr.String())

	stdout.Reset()
	mockServiceStatus(client, "foo", "bar")
	assert.Nil(t, cli.Run("status", "--cluster", "foo"))
	assert.Equal(t, "Container foo at http://127.0.0.1:8080 is ready\n", stdout.String())
}

func TestStatusCommandMultiClusterWait(t *testing.T) {
	client := &mock.HTTPClient{}
	cli, _, stderr := newTestCLI(t)
	cli.httpClient = client
	cli.retryInterval = 0
	mockServiceStatus(client, "foo", "bar")
	client.NextStatus(400)
	assert.NotNil(t, cli.Run("status", "--cluster", "foo", "--wait", "10"))
	assert.Equal(t, "Waiting up to 10s for cluster discovery...\nWaiting up to 10s for container foo...\n"+
		"Error: unhealthy container foo after waiting up to 10s: status 400 at http://127.0.0.1:8080/status.html: aborting wait: got status 400\n", stderr.String())
}

func TestStatusCommandWithUrlTarget(t *testing.T) {
	assertStatus("http://mycontainertarget:8080", []string{"-t", "http://mycontainertarget:8080"}, t)
}

func TestStatusCommandWithLocalTarget(t *testing.T) {
	assertStatus("http://127.0.0.1:8080", []string{"-t", "local"}, t)
}

func TestStatusError(t *testing.T) {
	client := &mock.HTTPClient{}
	mockServiceStatus(client, "default")
	client.NextStatus(500)
	cli, stdout, stderr := newTestCLI(t)
	cli.httpClient = client
	assert.NotNil(t, cli.Run("status", "container"))
	assert.Equal(t,
		"Container default at http://127.0.0.1:8080 is not ready: unhealthy container default: status 500 at http://127.0.0.1:8080/status.html: giving up\n",
		stdout.String())
	assert.Equal(t,
		"Error: services not ready: default\n",
		stderr.String())

	stdout.Reset()
	stderr.Reset()
	client.NextResponseError(io.EOF)
	assert.NotNil(t, cli.Run("status", "container", "-t", "http://example.com"))
	assert.Equal(t,
		"Container at http://example.com is not ready: unhealthy container at http://example.com/status.html: EOF\n",
		stdout.String())
	assert.Equal(t,
		"Error: services not ready: http://example.com\n",
		stderr.String())
}

func TestStatusLocalDeployment(t *testing.T) {
	client := &mock.HTTPClient{}
	cli, stdout, stderr := newTestCLI(t)
	cli.httpClient = client
	resp := mock.HTTPResponse{
		URI:    "/application/v2/tenant/default/application/default/environment/prod/region/default/instance/default/serviceconverge",
		Status: 200,
	}
	// Latest generation
	resp.Body = []byte(`{"currentGeneration": 42, "converged": true}`)
	client.NextResponse(resp)
	assert.Nil(t, cli.Run("status", "deployment"))
	assert.Equal(t, "", stderr.String())
	assert.Equal(t, "Deployment is ready on config generation 42\n", stdout.String())

	// Latest generation without convergence
	resp.Body = []byte(`{"currentGeneration": 42, "converged": false}`)
	client.NextResponse(resp)
	assert.NotNil(t, cli.Run("status", "deployment"))
	assert.Equal(t, "Warning: deployment not converged on latest generation: giving up\nHint: Consider using the --wait flag to wait for completion\n", stderr.String())

	// Explicit generation
	stderr.Reset()
	client.NextResponse(resp)
	assert.NotNil(t, cli.Run("status", "deployment", "41"))
	assert.Equal(t, "Warning: deployment not converged on generation 41: giving up\nHint: Consider using the --wait flag to wait for completion\n", stderr.String())
}

func TestStatusCloudDeployment(t *testing.T) {
	cli, stdout, stderr := newTestCLI(t, "CI=true")
	app := vespa.ApplicationID{Tenant: "t1", Application: "a1", Instance: "i1"}
	assert.Nil(t, cli.Run("config", "set", "application", app.String()))
	assert.Nil(t, cli.Run("config", "set", "target", "cloud"))
	assert.Nil(t, cli.Run("config", "set", "zone", "dev.us-north-1"))
	assert.Nil(t, cli.Run("auth", "api-key"))
	stdout.Reset()
	client := &mock.HTTPClient{}
	cli.httpClient = client
	// Latest run
	client.NextResponse(mock.HTTPResponse{
		URI:    "/application/v4/tenant/t1/application/a1/instance/i1/job/dev-us-north-1?limit=1",
		Status: 200,
		Body:   []byte(`{"runs": [{"id": 1337}]}`),
	})
	client.NextResponse(mock.HTTPResponse{
		URI:    "/application/v4/tenant/t1/application/a1/instance/i1/job/dev-us-north-1/run/1337?after=-1",
		Status: 200,
		Body:   []byte(`{"active": false, "status": "success"}`),
	})
	assert.Nil(t, cli.Run("status", "deployment"))
	assert.Equal(t, "", stderr.String())
	assert.Equal(t,
		"Deployment run 1337 has completed\nSee https://console.vespa-cloud.com/tenant/t1/application/a1/dev/instance/i1/job/dev-us-north-1/run/1337 for more details\n",
		stdout.String())
	// Explicit run with waiting
	client.NextResponse(mock.HTTPResponse{
		URI:    "/application/v4/tenant/t1/application/a1/instance/i1/job/dev-us-north-1/run/42?after=-1",
		Status: 200,
		Body:   []byte(`{"active": false, "status": "failure"}`),
	})
	assert.NotNil(t, cli.Run("status", "deployment", "42", "-w", "10"))
	assert.Equal(t, "Waiting up to 10s for deployment to converge...\nWarning: deployment run 42 incomplete after waiting up to 10s: aborting wait: run 42 ended with unsuccessful status: failure\n", stderr.String())
}

func isLocalTarget(args []string) bool {
	for i := 0; i < len(args)-1; i++ {
		if args[i] == "-t" {
			return args[i+1] == "local"
		}
	}
	return true // local is default
}

func assertDeployStatus(expectedTarget string, args []string, t *testing.T) {
	t.Helper()
	client := &mock.HTTPClient{}
	client.NextResponse(mock.HTTPResponse{
		URI:    "/status.html",
		Status: 200,
	})
	cli, stdout, _ := newTestCLI(t)
	cli.httpClient = client
	statusArgs := []string{"status", "deploy"}
	assert.Nil(t, cli.Run(append(statusArgs, args...)...))
	assert.Equal(t,
		"Deploy API at "+expectedTarget+" is ready\n",
		stdout.String())
	assert.Equal(t, expectedTarget+"/status.html", client.LastRequest.URL.String())
}

func assertStatus(expectedTarget string, args []string, t *testing.T) {
	t.Helper()
	client := &mock.HTTPClient{}
	clusterName := ""
	for i := 0; i < 3; i++ {
		if isLocalTarget(args) {
			clusterName = "foo"
			mockServiceStatus(client, clusterName)
		}
		client.NextResponse(mock.HTTPResponse{URI: "/status.html", Status: 200})
	}
	cli, stdout, _ := newTestCLI(t)
	cli.httpClient = client
	statusArgs := []string{"status"}
	assert.Nil(t, cli.Run(append(statusArgs, args...)...))
	prefix := "Container"
	if clusterName != "" {
		prefix += " " + clusterName
	}
	assert.Equal(t, prefix+" at "+expectedTarget+" is ready\n", stdout.String())
	assert.Equal(t, expectedTarget+"/status.html", client.LastRequest.URL.String())

	// Test legacy command
	statusArgs = []string{"status", "query"}
	stdout.Reset()
	assert.Nil(t, cli.Run(append(statusArgs, args...)...))
	assert.Equal(t, prefix+" at "+expectedTarget+" is ready\n", stdout.String())
	assert.Equal(t, expectedTarget+"/status.html", client.LastRequest.URL.String())

	// Plain format
	statusArgs = []string{"status", "--format=plain"}
	stdout.Reset()
	assert.Nil(t, cli.Run(append(statusArgs, args...)...))
	assert.Equal(t, expectedTarget+"\n", stdout.String())
}
